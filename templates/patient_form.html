{% extends "base.html" %}

{% block title %}
    {% if patient %}Edit Patient{% else %}Add New Patient{% endif %}
{% endblock %}

{% block page_title %}
    {% if patient %}
        <i class="fas fa-user-edit me-2"></i>Edit Patient: {{ patient.full_name }}
    {% else %}
        <i class="fas fa-user-plus me-2"></i>Add New Patient
    {% endif %}
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header" style="background-color: rgb(0, 255, 204);">
                <h5 class="mb-0">
                    <i class="fas fa-user-shield me-2"></i>
                    Patient Registration Form
                    <small class="d-block" style="font-size: 0.8rem;">Split Data Storage System</small>
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Data Privacy Notice:</strong> This system uses split-database architecture. 
                    Personal information is stored locally (SQLite), while medical data is anonymized and stored separately (Firebase). 
                    The two datasets are linked only by a secure UUID.
                </div>
                
                <form method="POST" action="{{ url_for('add_patient') if not patient else url_for('edit_patient', uuid=patient.uuid) }}" 
                      id="patientForm" novalidate>
                    
                    <!-- Personal Information Section - STORED IN SQLITE -->
                    <div class="card mb-4 border-success">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-laptop-house me-2"></i>
                                Personal Information
                                <small class="d-block" style="font-size: 0.8rem;">Stored Locally in SQLite for Privacy</small>
                            </h6>
                        </div>
                        <div class="alert alert-warning mb-4">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Note:</strong> Personal information (name, phone, email) is stored locally and <strong>NOT displayed</strong> on the website. 
                            Only medical data (age, height) from Firebase is displayed for anonymous analysis.
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="full_name" class="form-label">
                                        <i class="fas fa-user me-1"></i>Full Name *
                                    </label>
                                    <input type="text" class="form-control" id="full_name" name="full_name" 
                                           value="{{ patient.full_name if patient else '' }}" required
                                           placeholder="Patient's full name">
                                    <div class="invalid-feedback">
                                        Please provide the patient's full name.
                                    </div>
                                    <div class="form-text">
                                        <i class="fas fa-database text-success me-1"></i>
                                        Stored in local SQLite database
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="phone" class="form-label">
                                        <i class="fas fa-phone me-1"></i>Phone Number *
                                    </label>
                                    <input type="tel" class="form-control" id="phone" name="phone" 
                                           value="{{ patient.phone if patient else '' }}" required
                                           placeholder="e.g., 555-123-4567">
                                    <div class="invalid-feedback">
                                        Please provide a valid phone number.
                                    </div>
                                    <div class="form-text">
                                        <i class="fas fa-database text-success me-1"></i>
                                        Stored in local SQLite database
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="email" class="form-label">
                                    <i class="fas fa-envelope me-1"></i>Email Address *
                                </label>
                                <input type="email" class="form-control" id="email" name="email" 
                                       value="{{ patient.email if patient else '' }}" required
                                       placeholder="patient@example.com">
                                <div class="invalid-feedback">
                                    Please provide a valid email address.
                                </div>
                                <div class="form-text">
                                    <i class="fas fa-database text-success me-1"></i>
                                    Stored in local SQLite database
                                </div>
                            </div>
                            
                            {% if patient %}
                            <div class="alert alert-secondary">
                                <i class="fas fa-key me-2"></i>
                                <strong>Patient UUID:</strong> {{ patient.uuid }}
                                <small class="d-block text-muted">This unique identifier links personal and medical data across databases</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Medical Information Section - STORED IN FIREBASE -->
                    <div class="card mb-4 border-info">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-cloud me-2"></i>
                                Medical Information
                                <small class="d-block" style="font-size: 0.8rem;">Stored Anonymously in Firebase Cloud</small>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="age" class="form-label">
                                        <i class="fas fa-birthday-cake me-1"></i>Age
                                    </label>
                                    <input type="number" class="form-control" id="age" name="age" 
                                           min="18" max="60" 
                                           value="{{ medical_data.age if medical_data else '' }}"
                                           placeholder="Age in years">
                                    <div class="form-text">
                                        <i class="fas fa-cloud text-info me-1"></i>
                                        Stored anonymously in Firebase
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="height" class="form-label">
                                        <i class="fas fa-ruler-vertical me-1"></i>Height (cm)
                                    </label>
                                    <input type="number" class="form-control" id="height" name="height" 
                                           min="140" max="200" step="0.1"
                                           value="{{ medical_data.height if medical_data else '' }}"
                                           placeholder="Height in centimeters">
                                    <div class="form-text">
                                        <i class="fas fa-cloud text-info me-1"></i>
                                        Stored anonymously in Firebase
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-warning">
                                <i class="fas fa-cloud me-2"></i>
                                <strong>Storage Location:</strong> This medical data will be stored anonymously in Firebase Firestore.
                                No personal identifiers are included in the cloud database.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data Flow Diagram -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-project-diagram me-2"></i>Data Flow Architecture</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <div class="p-3 border rounded">
                                        <div class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2" 
                                             style="width: 50px; height: 50px;">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <h6>Personal Data</h6>
                                        <small class="text-success">
                                            <i class="fas fa-laptop-house me-1"></i>
                                            SQLite (Local)
                                        </small>
                                        <ul class="list-unstyled small text-start mt-2">
                                            <li><i class="fas fa-check text-success me-1"></i>Full Name</li>
                                            <li><i class="fas fa-check text-success me-1"></i>Phone</li>
                                            <li><i class="fas fa-check text-success me-1"></i>Email</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-3">
                                        <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2" 
                                             style="width: 50px; height: 50px;">
                                            <i class="fas fa-key"></i>
                                        </div>
                                        <h6>UUID Link</h6>
                                        <small>Secure Anonymous Identifier</small>
                                        <div class="mt-2">
                                            <code style="font-size: 0.7rem;">{{ patient.uuid[:16] if patient else 'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx' }}...</code>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-3 border rounded">
                                        <div class="bg-info text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-2" 
                                             style="width: 50px; height: 50px;">
                                            <i class="fas fa-heartbeat"></i>
                                        </div>
                                        <h6>Medical Data</h6>
                                        <small class="text-info">
                                            <i class="fas fa-cloud me-1"></i>
                                            Firebase (Cloud)
                                        </small>
                                        <ul class="list-unstyled small text-start mt-2">
                                            <li><i class="fas fa-check text-info me-1"></i>Age</li>
                                            <li><i class="fas fa-check text-info me-1"></i>Height</li>
                                            <li><i class="fas fa-check text-info me-1"></i>Medical Metrics</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            {% if patient %}
                                <i class="fas fa-save me-2"></i>Update Patient
                            {% else %}
                                <i class="fas fa-user-plus me-2"></i>Add Patient
                            {% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Form validation
(function () {
    'use strict'
    
    const form = document.getElementById('patientForm');
    
    form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        form.classList.add('was-validated');
    }, false);
    
    // Email validation
    const emailInput = document.getElementById('email');
    emailInput.addEventListener('input', function() {
        if (emailInput.validity.typeMismatch) {
            emailInput.setCustomValidity('Please enter a valid email address');
        } else {
            emailInput.setCustomValidity('');
        }
    });
    
    // Phone validation (simple)
    const phoneInput = document.getElementById('phone');
    phoneInput.addEventListener('input', function() {
        const phoneRegex = /^[\d\s\-\+\(\)]{10,}$/;
        if (!phoneRegex.test(phoneInput.value)) {
            phoneInput.setCustomValidity('Please enter a valid phone number (minimum 10 digits)');
        } else {
            phoneInput.setCustomValidity('');
        }
    });
})();
</script>
{% endblock %}